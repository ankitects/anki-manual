# AnkiWebとの同期

<!-- toc -->

AnkiWebは、複数のデバイス間でコレクションを同期し、オンラインで学習できるサービスです。以下の手順に従う前に、[無料アカウント](https://ankiweb.net/)に登録してください。

## 紹介動画

同期についての簡単な紹介は、[同期の紹介動画](https://www.youtube.com/watch?v=YkiM4DPzSVc&list=PLGgmaKOIHykFoomqkBJAyGiDQ2kyiuTao&yt:cc=on)をご覧ください。

## セットアップ

デバイス間でコレクションの同期を開始するには、同期ボタン（[メイン画面](studying.md#decks)の右上のボタン）をクリックするか、キーボードで<kbd>Y</kbd>を押します。
登録時に作成したAnkiWeb IDとパスワードの入力を求められます。

初めてコレクションを同期する際、Ankiはアップロードするかダウンロードするかを尋ねてきます。コンピュータにカードがあり、AnkiWebアカウントが空の場合は、**アップロード**を選択してデータをAnkiWebに送信します。別のデバイスからAnkiWebにカードがあり、コンピュータにカードがない場合は、**ダウンロード**を選択して、空のローカルコレクションをAnkiWeb上のカードで置き換えます。両方のデバイスに異なるカードがある場合は、データの損失を避けるために[追加の作業](#マージの競合)が必要です。

初回の一方向同期が完了すると、Ankiはいくつかの例外を除いて複数の場所からの変更をマージできるようになります。

一台のマシンで複数の人がAnkiを使用し、各ユーザー用にプロファイルを作成している場合、各ユーザーは同期するために独自のAnkiWebアカウントを作成する必要があります。単一のAnkiWebアカウントで複数のプロファイルを同期しようとすると、データが失われます。

## 自動同期

同期が有効になると、Ankiはコレクションが閉じられたり開かれたりするたびに自動的に同期します。手動で同期したい場合は、Ankiの[設定](preferences.md#syncing)で自動同期を無効にできます。

## ボタンの色

同期ボタンは通常の同期が必要な場合は青色に、フル同期が必要な場合は赤色に変わります。

## メディア

このトピックに関する[関連動画](https://www.youtube.com/watch?v=phP9GGG-PxY)をご覧いただけます。

Ankiはノートで使用される音声や画像を同期します。[メディアフォルダ](files.md#file-locations)でメディアが追加、削除、置換されたときには検出しますが、既存のファイルに編集を加えた場合は検出しません。編集を同期させるには、ファイルの追加、削除、または置換も行う必要があります。

一方向同期（アップロードまたはダウンロードを求められる場合）は、メディアの同期方法には影響しません - メディアの変更は常にマージされます。

誤ったデータ損失を防ぐため、削除はメディアが完全に同期された後に行われた場合にのみ他のデバイスに同期されます。デバイスが完全に同期される前にファイルを削除し、削除されたファイルがすでにAnkiWebに存在する場合、次回の同期時にダウンロードされます。

誤ってメディアファイルを削除してしまい、復元したい場合は、設定を開いてログアウトしてください。次回同期する際、AnkiWebにまだ利用可能であれば、削除されたファイルが復元されます。

[USBフラッシュドライブ](files.md#running-from-a-flash-drive)からAnkiを実行している場合は、NTFSファイルシステムを使用する必要があります。AnkiはFAT32ファイルシステムでのメディアの変更を検出できない可能性があります。

## 競合

このトピックに関する[関連動画](https://www.youtube.com/watch?v=UEAcpfMQnjo)をご覧いただけます。

通常の状況では、復習とノートの編集はマージできるため、同期前に2つの異なるデバイスで復習または編集を行っても、Ankiは両方の場所からの変更を保持します。同じカードが2つの異なる場所で復習された場合、両方の復習が復習履歴に記録され、カードは最後に回答されたときの状態に保持されます。

Ankiがマージできない特定の変更があります。これらは主にノートの形式に関連するもので、新しいフィールドの追加やカードテンプレートの削除などです。マージできない操作を実行すると、Ankiは警告を表示し、操作を中止するオプションを提供します。続行を選択した場合、次回コレクションが同期されるときに、ローカルコピーまたはAnkiWeb上のコピーのどちらを保持するかを選択するよう求められます。

同期中に特定の問題が検出された場合、一方向同期が強制されることもあります。これが一貫して発生する場合は、[サポートサイト](https://forums.ankiweb.net)に投稿してください。

一方向同期が必要な場合、ローカルデバイス上のコレクションを保持するか、AnkiWeb上のコレクションを保持するかを選択する必要があります。両端で変更が行われている場合、一方の端の変更のみを保持できます。

**アップロード**を選択すると、ローカルデバイス上のコンテンツがAnkiWebに送信されます。その後、他のデバイスを同期し、**ダウンロード**を選択してそのコンテンツのコピーを取得する必要があります。

**ダウンロード**を選択すると、ローカルで行った変更がAnkiWeb上のデータで置き換えられます。

すべてのデバイスが同期されると、今後の同期は両端からの変更をマージする通常の動作に戻ります。

フルアップロードまたはダウンロードを強制したい場合（例えば、誤って片側でデッキを削除してしまい、削除を同期させるのではなくデッキを復元したい場合）、
**ツール &gt; 設定 &gt; ネットワーク**で「次回の同期時に一方向に変更を強制する」ボックスをチェックし、通常通り同期します。（どちら側を使用するかを選択するオプションが表示されます。）

一方向同期の強制はカードの同期にのみ影響します - メディアは通常通り同期されます。AnkiWebから削除したいファイルがある場合は、まずクライアントが完全に同期されていることを確認してください。同期が最新の状態になった後、削除したファイル（例：**メディアをチェック**機能を使用）は、次回の同期でAnkiWebから削除されます。

## マージの競合

[最初の同期](#セットアップ)は一方向にしか変更を同期できないため、同期を設定する前に異なるデバイスやプロファイルに異なるコンテンツを追加していた場合、一方のデバイスのコンテンツを他のデバイスのコンテンツで上書きすると、一方のデバイスのコンテンツが失われます。作業を行うことで、データを単一のコレクションに手動でマージすることが可能です。

まず、何か問題が発生した場合に備えて、各デバイス/プロファイルでバックアップを取ります。コンピュータ版では、**ファイル &gt; エクスポート**を使用して、スケジュール情報とメディアファイルを含む「すべてのデッキ」をエクスポートし、ファイルを安全な場所に保存できます。AnkiMobileでは、デッキリスト画面の追加/エクスポートボタンで、メディアを含むすべてのデッキをエクスポートできます。

次に、デバイスの1つがモバイルデバイスの場合は、最初にそれを同期します。競合がある場合は、**アップロード**を選択して、AnkiWeb上の既存のデータをモバイルデバイスのデータで上書きします。両方のデバイス/プロファイルがコンピュータ上にある場合は、デッキ数が最も多いデバイス/プロファイルを最初に同期します。

次に、他のデバイス/プロファイルに戻ります。自動同期が有効になっている場合、アップロードまたはダウンロードするかを尋ねるメッセージがポップアップする場合があります。キャンセルボタンをクリックしてください - まだ同期したくありません。

デッキリストが表示されたら、最初のデッキの横にある歯車アイコンをクリックし、**エクスポート**を選択します。スケジュール情報とメディアを含めてコンテンツをエクスポートし、`.apkg`ファイルをどこかに保存します。これを各トップレベルデッキに対して繰り返す必要があります。

すべてのトップレベルデッキがエクスポートされたら、右上の同期ボタンをクリックして**ダウンロード**を選択します。これにより、ローカルコンテンツが他のデバイスから同期したコンテンツで上書きされます。

これで**ファイル &gt; インポート**を使用して、先ほどエクスポートした`.apkg`ファイルをインポートできます。これにより、エクスポートされたコンテンツが既存のコンテンツとマージされ、すべてが1つの場所にまとまります。

## AnkiWebデータの削除

AnkiWebは無料サービスであるため、コストを抑えるために未使用のアカウントデータを定期的に削除する必要があります。過去6か月間アカウントにアクセスしたり同期したりしていない場合、アカウントのデータが削除される可能性があります。

### 削除されるもの

AnkiWebに保存されているデータのみが削除されます。アカウント自体は残り、再度使用できます。

コンピュータ、電話、タブレットに保存されているカードは、それらのデバイスに残ります。アカウントから共有されたアイテム（デッキやアドオンを含む）もAnkiWebに残ります。

### AnkiWebへの復帰

デッキデータの有効期限が切れた後は、AnkiWebからデータを回復することはできませんが、ローカルコピーまたは[バックアップ](./backups.md)がある場合は回復できる可能性があります。

### データ削除の回避

ankiweb.netにアクセスしたり、Anki、AnkiMobile、またはAnkiDroidで同期機能を使用したりするたびに、アカウントは自動的にアクティブとマークされます。

アカウントが6か月以上非アクティブで、サービスを1週間以上使用していた場合、削除が保留中であることを通知するメールが送信されます。アカウントをアクティブに保ちたい場合は、30日以内にankiweb.netにログインしてカードを学習するか、デバイスの1つを同期してください。

## ファイアウォール

Ankiは同期するために外向きのHTTPS接続を行う必要があります。ankiweb.net、sync.ankiweb.net、sync2.ankiweb.netなどに接続できる必要があります。これらのドメインは時間とともに変更される可能性があり、それらが指すIPアドレスも変更される可能性があるため、将来ファイアウォールルールを更新する必要性を減らすために、\*.ankiweb.netへのワイルドカードアクセスを許可することをお勧めします。

マシンにファイアウォールがある場合は、Ankiの例外を追加する必要があります。職場や学校のネットワークを使用している場合は、ネットワーク管理者に支援を求めてください - これは私たちがお手伝いできることではありません。

## プロキシ

インターネットにアクセスするためにプロキシが必要な場合、WindowsまたはmacOSを使用している場合、Ankiは自動的にシステムのプロキシ設定を取得します。他のプラットフォームを使用している場合は、HTTP_PROXY環境変数を尊重します。

Ankiがシステム設定を取得できるのは、プロキシが手動で設定されており、パスワードを必要としない場合のみです。システムが自動プロキシ設定を使用している場合、またはユーザー名とパスワードが必要なプロキシを使用している場合は、Ankiにプロキシ設定を手動で伝える必要があります。

Ankiにプロキシ設定を伝えるには、プロキシサーバーを指すHTTPS_PROXY環境変数を定義します。次のようになります：

    http://user:pass@proxy.company.com:8080

ユーザー名またはパスワードに@が含まれている場合（例：`user@workdomain.com`）、次のように%40に変更する必要があります：

    http://user%40workdomain.com:pass@proxy.company.com:8080

Anki 2.0は、HTTPS_PROXYではなくHTTP_PROXYを期待しています。

Windowsで環境変数を設定するには、次を参照してください：
<https://www.google.com/search?q=windows+set+environmental+variable>

Macを使用している場合は、次を参照してください：
<http://stackoverflow.com/questions/135688/setting-environment-variables-in-os-x>

セキュアな接続を傍受し、独自の証明書を提示する厳しくロックダウンされたネットワークでは、AnkiがSSLエラーを発生させる可能性があります。このような環境では、[このアドオン](https://ankiweb.net/shared/info/1332261690)を使用してエラーを回避できる場合があります。

別の解決策は、ローカルプロキシサーバーをインストールし、そのプロキシサーバーを通常使用するプロキシサーバーに向けることです。その後、Ankiにローカルプロキシを使用するように指示でき、通常使用するプロキシにリクエストがリダイレクトされます。