# ファイルとコレクションの管理

<!-- toc -->

## コレクションのチェック

定期的にコレクションファイルの問題をチェックすることをお勧めします。ツール&gt;データベースをチェックメニューアイテムから実行できます。
データベースのチェックは、ファイルが破損していないことを確認し、いくつかの内部構造を再構築し、ファイルを最適化します。

データベースをチェックすると、タグリストも再構築されます。個々のデッキやカードを削除しても、Ankiは使用されているタグのリストを更新しません。非効率的だからです。使用されなくなった古いタグをリストからクリアしたい場合は、データベースのチェックが方法です。

Ankiは2週間に1回、コレクションを自動的に最適化することに注意してください。この最適化はコレクションのパフォーマンスを確保しますが、自動最適化時にはエラーのチェックやタグリストの再構築は行いません。

## ファイルの場所

**Windows**では、最新のAnkiバージョンはAnkiファイルをappdataフォルダに保存します。ファイルマネージャーを開き、場所フィールドに`%APPDATA%\Anki2`と入力することでアクセスできます。古いバージョンのAnkiは、`Documents`フォルダ内の`Anki`というフォルダにAnkiファイルを保存していました。

**Mac**コンピュータでは、最近のAnkiバージョンはすべてのファイルを`~/Library/Application Support/Anki2`フォルダに保存します。Libraryフォルダはデフォルトで非表示になっていますが、Goメニューをクリックしながらoptionキーを押すことでFinderで表示できます。古いAnkiバージョンを使用している場合、Ankiファイルは`Documents/Anki`フォルダにあります。

**Linux**では、最近のAnkiバージョンはデータを`~/.local/share/Anki2`、またはカスタムデータパスを設定している場合は`$XDG_DATA_HOME/Anki2`に保存します。サードパーティの**Flatpak**ビルドを使用している場合、ファイルは`~/.var/app/net.ankiweb.Anki/data/Anki2/`にあります。
古いバージョンのAnkiはファイルを`~/Documents/Anki`または`~/Anki`に保存していました。

Ankiフォルダ内では、プログラムレベルとプロファイルレベルの設定がprefs.dbというファイルに保存されています。

各プロファイルには個別のフォルダもあります。フォルダには以下が含まれます：

- collection.anki2というファイルにノート、デッキ、カードなど

- collection.mediaフォルダに音声と画像

- backupsフォルダ

- いくつかのシステムファイル

Ankiが開いている間は、コレクションをコピーまたは移動してはいけません。そうするとコレクションが破損する可能性があります。フォルダ内の他のファイルも移動や変更しないでください。

## 起動オプション

あるコンピュータで破壊的な変更を加え、別のコンピュータに損傷のないコピーがある場合、まず変更をダウンロードせずに完全同期オプションを使用するために、同期せずにAnkiを起動したい場合があります。同様に、Ankiで問題が発生している場合、問題を引き起こしている可能性があるかどうかを確認するために、一時的にアドオンを無効にする必要があるかもしれません（または指示されるかもしれません）。これらの両方を同時に行うには、Ankiの起動時に<kbd>Shift</kbd>キーを押したままにすることで、Ankiをセーフモードで開くことができます。画面上のメッセージがAnkiがセーフモードで起動したことを通知するまで<kbd>Shift</kbd>を押し続けてください。

起動時にカスタムフォルダの場所を指定することができます。これは主にポータブルインストールで使用することを意図した高度な機能であり、ほとんどの場合はデフォルトの場所を使用することをお勧めします。

代替フォルダを指定する構文は次のとおりです：

    anki -b /path/to/anki/folder

- 複数のプロファイルがある場合、-p &lt;name&gt;を渡して特定のプロファイルを読み込むことができます。
- -p some-fake-nameを渡すと、Ankiは起動時にプロファイル画面を表示します。
  プロファイルが提供されない場合、最後に使用されたプロファイルが読み込まれます。

- インターフェース言語を変更するには、-l &lt;iso 639-1 言語コード&gt;を使用します（例：日本語の場合は"-l ja"）。

常にカスタムフォルダの場所を使用したい場合は、Ankiへのショートカットを変更できます。Windowsでは、ショートカットを右クリックし、プロパティを選択し、ショートカットタブを選択し、プログラムへのパスの後に"-b \\path\\to\\data\\folder"を追加します。結果は次のようになります：

    "C:\Program Files\Anki\anki.exe" -b "C:\AnkiDataFolder"

このテクニックを-lオプションと共に使用して、Ankiを異なる言語で簡単に使用することもできます。

Windowsでは、フォワードスラッシュ（/）ではなくバックスラッシュ（\\）を使用する必要があります。

MacでAnkiアイコンをクリックしたときの動作を簡単に変更する方法はありませんが、ターミナルからカスタムベースフォルダでAnkiを起動することは可能です：

    open /Applications/Anki.app --args -b ~/myankifolder

代わりに、環境変数"ANKI_BASE"を定義することもできます。
Windowsでは、次のように環境変数を定義できます：

    set "ANKI_BASE=C:/path/to/AnkiDataFolder"

LinuxとmacOSでは、次を使用できます：

    export ANKI_BASE="/path/to/AnkiDataFolder"

## DropBoxとファイル同期

Ankiフォルダをサードパーティの同期サービスと直接同期することはお勧めしません。使用中にファイルが同期されるとデータベースの破損につながる可能性があるためです。

メディアだけを同期したい場合は、DropBoxなどのサービスに外部フォルダをリンクできます。詳細については[DropboxWiki: Sync Folders Outside Dropbox (archive.org)][dropboxwiki-sync-other]を参照してください。

[dropboxwiki-sync-other]: http://web.archive.org/web/20180919153730/http://www.dropboxwiki.com/tips-and-tricks/sync-other-folders

コレクションも同期したい場合は、同期フォルダからローカルフォルダにファイルをコピーし、Ankiを起動し、Ankiが閉じられたときにファイルをコピーバックするスクリプトを作成することを強くお勧めします。これにより、ファイルが開いている間に同期されることがなくなります。

## ネットワークファイルシステム

ネットワークファイルシステムはデータベースの破損につながる可能性があるため、Ankiファイルをローカルハードディスクに保存することを強くお勧めします。ネットワークファイルシステムが唯一の選択肢である場合は、破損を検出するためにツール&gt;データベースをチェックを定期的に使用することをお勧めします。

## フラッシュドライブからの実行

Windowsでは、AnkiをUSB/フラッシュドライブにインストールして、ポータブルアプリケーションとして実行できます。次の例では、USBドライブがドライブGであると仮定します。

- \\Program Files\\Ankiフォルダをフラッシュドライブにコピーして、G:\\Ankiのようなフォルダを作成します。

- 次のテキストを含むG:\\anki.batというテキストファイルを作成します：

  g:\anki\anki.exe -b g:\ankidata

黒いコマンドプロンプトウィンドウが開いたままになるのを防ぎたい場合は、代わりに次を使用できます：

    start /b g:\anki\anki.exe -b g:\ankidata

- anki.batをダブルクリックすると、ユーザーデータがG:\\ankidataに保存された状態でAnkiが起動するはずです。

ドライブレターを含む完全なパスが必要です - `\anki\anki.exe`を使用しようとすると、同期が動作しなくなります。

フラッシュドライブがFAT32としてフォーマットされている場合、AnkiWebとのメディア同期が機能しない場合があります。メディアが正しく同期されるように、ドライブをNTFSとしてフォーマットしてください。

## バックアップ

[このセクション](./backups.md)を参照してください。

## アクセスできないハードディスク

Ankiが[Ankiフォルダ](#ファイルの場所)内のファイルに書き込めない場合、起動時にAnkiがハードディスクに書き込めないというメッセージが表示され、Ankiは閉じます。権限の修正方法がわからない場合は、コンピュータに詳しい近くの人に連絡して助けてもらってください。

## Tempフォルダの権限

Ankiは一時データを保存するためにシステムの一時フォルダを使用します。このフォルダの権限が不正なアプリやバグのあるアンチウイルスアプリによってデフォルト設定から変更されている場合、Ankiは正しく機能しません。

Windows 7マシンを使用している場合、問題を修正するための一般的な手順を以下に示します。これはやや複雑なので、よくわからない場合はWindowsに詳しい人に尋ねてください。

1. スタートバーをクリックし、%temp%（パーセントを含む）と入力して、<kbd>Enter</kbd>を押します。

2. 1つ上のフォルダに移動し、tempフォルダを見つけます。右クリックして、プロパティを選択します。

3. セキュリティタブで、詳細設定をクリックします。

4. 所有者タブをクリックします。所有者としてリストされていない場合は、所有権を取得するボタンをクリックします。

5. アクセス許可タブで、フルコントロールがあることを確認します。デフォルトのW7インストールでは、コントロールは実際にc:\\users\\your-usernameから継承されます。

## 破損したコレクション

Ankiはプログラムとコンピュータのクラッシュに対して堅牢なファイル形式を使用していますが、Ankiが開いている間にファイルが変更されたり、ネットワークドライブに保存されたり、バグによって破損したりすると、コレクションが破損する可能性があります。

ツール&gt;データベースをチェックを実行すると、Ankiがファイルの破損を検出した場合にメッセージが表示されます。**これから回復する最良の方法は、最新の[自動バックアップ](#バックアップ)から復元することです**が、バックアップが古すぎる場合は、代わりに破損を修復することを試みることができます。

Linuxでは、sqlite3がインストールされていることを確認してください。Macでは、すでにインストールされているはずです。Windowsでは、<http://www.sqlite.org/sqlite-3_6_23.zip>をダウンロードしてください。

次に、以下の手順で何か問題が発生した場合に備えて、collection.anki2ファイルのバックアップを作成してください。

### Linux/macOS

ターミナルを開き、コレクションがあるフォルダに移動し、次を入力します：

    sqlite3 collection.anki2 .dump > dump.txt

結果のdump.txtファイルをテキストエディタで開き、最終行を見てください。"rollback;"と書かれている場合は、"commit;"に変更してください。

次に、ターミナルで以下を実行します：

    cat dump.txt | sqlite3 temp.file

temp.fileを使用していることを確認してください - 右側にcollection.anki2を置かないでください。そうするとファイルが空白になります。完了したら、最終ステップに進んでください。

### Windows

`sqlite3.exe`プログラムとデッキをデスクトップにコピーします。次に**スタート&gt;ファイル名を指定して実行**に移動し、`cmd.exe`と入力します。

最近のWindowsでは、コマンドプロンプトがデスクトップで起動しない場合があります。コマンドプロンプトにデスクトップが表示されない場合は、次のように入力し、"administrator"をログイン名に置き換えてください。

    cd C:\Users\Administrator\Desktop

次に入力します：

    sqlite3 collection.anki2 .dump > dump.txt

結果のdump.txtファイルをテキストエディタで開き、最終行を見てください。"rollback;"と書かれている場合は、"commit;"に変更してください。

次に、ターミナルで以下を実行します：

    type dump.txt | sqlite3 temp.file

temp.fileを使用していることを確認してください - 右側にcollection.anki2を置かないでください。そうするとファイルが空白になります。完了したら、最終ステップに進んでください。

### 最終ステップ

エラーメッセージが表示されず、temp.fileが空でないことを確認してください。この手順ではコレクションが最適化されるため、新しいファイルが古いファイルよりもやや小さくなるのは正常です。

ファイルが空でないことを確認したら：

- 元のcollection.anki2ファイルの名前を別のものに変更します

- temp.fileをcollection.anki2に名前変更します

- collection.anki2をコレクションフォルダに戻し、古いバージョンを上書きします

- Ankiを起動し、ツール&gt;データベースをチェックに移動して、コレクションが正常に復元されたことを確認します。